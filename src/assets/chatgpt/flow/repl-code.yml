name: REPL Code
category: Development
author: Phodal Huang
description: REPL Service for ClickFlow
explain: |
  digraph G {
    0[flowType = "prompt"]
  }

stepGuide: false
replService: true
steps:
  - name: It does not work
    ask: |
      检查一下你的代码是否可以运行：

      ```kotlin
      x + 10086
      ```

      这个代码是跑不了的
  - name: It works
    ask: |
      ```kotlin
      var x = 1
      x + 10086
      ```
  - name: Kotlin Ktor
    ask: |
      ```kotlin
      @file:Repository("https://packages.jetbrains.team/maven/p/ktls/maven")
      @file:Repository("https://repo.maven.apache.org/maven2/")

      @file:DependsOn("io.kotless:kotless-lang:0.2.0")
      @file:DependsOn("io.kotless:kotless-lang-local:0.2.0")
      @file:DependsOn("io.kotless:ktor-lang:0.2.0")
      @file:DependsOn("io.kotless:ktor-lang-local:0.2.0")

      @file:DependsOn("com.h2database:h2:2.1.212")

      @file:DependsOn("org.jetbrains.exposed:exposed-core:0.40.1")
      @file:DependsOn("org.jetbrains.exposed:exposed-dao:0.40.1")
      @file:DependsOn("org.jetbrains.exposed:exposed-jdbc:0.40.1")

      import io.kotless.dsl.ktor.KotlessAWS
      import kotlin.reflect.full.primaryConstructor

      import io.ktor.application.*
      import io.ktor.request.*
      import io.ktor.response.*
      import io.ktor.routing.*
      import io.ktor.server.engine.*
      import io.ktor.server.netty.*
      import org.jetbrains.exposed.sql.Database
      import org.jetbrains.exposed.sql.SchemaUtils
      import org.jetbrains.exposed.sql.insert
      import org.jetbrains.exposed.sql.transactions.transaction

      data class User(val id: Int, val username: String)

      class Server : KotlessAWS() {
          override fun prepare(app: Application) {
              Database.connect("jdbc:h2:mem:test", driver = "org.h2.Driver")

              transaction {
                  SchemaUtils.create(Users)
              }

              app.routing {
                  post("/register") {
                      val user = call.receive<User>()
                      val id = transaction {
                          // Insert the new user into the database
                          Users.insert {
                              it[username] = user.username
                          } get Users.id
                      }

                      val newUser = User(id, user.username)
                      call.respond(newUser)
                  }
              }
          }
      }

      object Users : org.jetbrains.exposed.sql.Table("users") {
          val id = integer("id").autoIncrement()
          val username = varchar("username", 50).uniqueIndex()

          override val primaryKey = PrimaryKey(id, name = "PK_User_ID")
      }

      fun main(port: Int) {
          val classToStart = Server::class.java.name

          val ktClass = ::main::class.java.classLoader.loadClass(classToStart).kotlin
          val instance = (ktClass.primaryConstructor?.call() ?: ktClass.objectInstance) as? KotlessAWS

          val kotless =
              instance ?: error("The entry point $classToStart does not inherit from ${KotlessAWS::class.qualifiedName}!")

          embeddedServer(Netty, port) {
              kotless.prepare(this)
          }.start(wait = true)
      }

      main(8848)
      ```

  - name: Kotlin Spring Sample
    ask: |
      ```kotlin
      // SLf4j 1.7 can accidentially be pulled in using Spring Boot 3 leading to exceptions
      // https://github.com/spring-projects/spring-boot/issues/33854
      @file:DependsOn("org.springframework.boot:spring-boot-starter-web:2.7.9")
      // logging.level.org.springframework.boot.autoconfigure=INFO
      //@file:CompilerOptions("-jvm-target", "1.8", "-Xabi-stability=unstable")
      //@file:DependsOn("ch.qos.logback:logback-classic:1.3.4", options = ["transitive=false"])
      //@file:DependsOn("org.apache.logging.log4j:log4j-slf4j-impl:2.20.0")
      package sample

      import org.springframework.boot.*
      import org.springframework.boot.autoconfigure.*
      import org.springframework.context.annotation.ComponentScan
      import org.springframework.context.annotation.Configuration
      import org.springframework.web.bind.annotation.*
      import java.util.*

      @RestController
      class SampleController {
        @GetMapping("/hello")
        fun helloKotlin(): String {
          return "hello world"
        }
      }

      @Configuration
      @ComponentScan(basePackageClasses = [SampleController::class])
      @SpringBootApplication
      open class ReplApplication

      fun main(args: Array<String>) {
        SpringApplication(ReplApplication::class.java).run(*args)
      }

      main(arrayOf("--server.port=8083"))
      ```
